<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Educational Resource Management</title>

    <link rel="canonical" href="https://getbootstrap.com/docs/4.0/examples/blog/">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link href="css/message.css" rel="stylesheet">
    <link href="css/navbar.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.1.0/firebase-firestore.js"></script>
    <style>
      .apply-flex {
        display: flex;
      }
  
      .card-block {
        width: 760px;
        margin: auto
      }
  
      .error {
        color: red;
      }
  
      .error-dis {
        display: none;
      }
  
      .form-control {
        width: 300px;
        display: inline;
      }
      .handle-form {
        margin: 0 0 0 410px;
      }
  
      .form-btn {
        margin: 0 410px 0 0;
      }
    </style>

  </head>

  <body>

    <div class="container">
      <header class="py-3">
        <div class = "navbar-header">
            <h3>University at Albany</h3>
        </div>
      </header>

      <div class="nav-scroller py-1 mb-2">
        <nav class="navbar navbar-expand-lg navbar-light" style="background-color: #dab3ff">
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarText">
            <ul class="navbar-nav mr-auto">
              <li class="nav-item">
                <a class="nav-link" href="blog.html">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="courses.html">Courses</a>
              </li>
              <li class="nav-item active">
                <a class="nav-link" href="messagecenter.html">Message Center<span class="sr-only">(current)</span></a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="messages.html">Messages</a>
              </li>
            </ul>
          <form class="form-inline my-2 my-lg-0" action='blog_results.html'method="GET">
            <input class="form-control mr-sm-2" name="search"type="search" placeholder="Search" aria-label="Search">
            <button class="btn btn-outline-primary" type="submit">Search</button>
            <ul class="navbar-nav ml-auto">
              <li class="nav-item">
                <a class="nav-link" href="javascript:handleLogging()"><span id="logging"></span></a>
              </li>
            </ul>
          </form>

         </div>
        </nav>
      </div>
      <div name="messagecenter">
         
          <div class="handle-form">
              <div>
                  <strong>For which subjects have you enrolled?</strong>
                </div>
                <br>
          <div class="apply-flex">
            <input type="text" id="course1" class="form-control" placeholder="Course 1" name="course1" autofocus>
            <span class="error error-dis" id="error-cname1">Please enter a valid course</span>
          </div>
          <br>
          <div class="apply-flex">
            <input type="text" id="course2" class="form-control" placeholder="Course 2" name="course2" autofocus>
            <span class="error error-dis" id="error-cname2">Please Enter a valid course</span>
          </div>
          <br>
          <div class="apply-flex">
            <input type="text" id="course3" class="form-control" placeholder="Course 3" name="course3" autofocus>
            <span class="error error-dis" id="error-cname3">Please Enter a valid course</span>
          </div>
          <br>
          <button class="form-btn" type="button" onclick="subscribe()">Subscribe</button>
        </div>
      </div>
    <!-- <main role="main" class="container">
      <div class="row">
          <div class="notification">
          <p>
            <strong>For which subjects have you enrolled?</strong>
          </p>
          Course1: <input id="course1" type="text">
          <br>
          Course2: <input id="course2" type="text">
          <br>
          Course3: <input id="course3" type="text">
          <br>
          <button type="button" onclick="subscribe()">Subscribe</button>

          </div> -->
          <!-- <div class="notification">
                <a href="#">New Blog Post</a>
            <p>
              <strong>Jon Snow</strong> has posted a new blog post: <br>
                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin maximus mauris non justo convallis, in feugiat nunc commodo. Fusce pellentesque velit id magna posuere, laoreet ullamcorper enim vehicula. Sed ac condimentum urna. Vivamus rhoncus bibendum dui sit amet viverra...
            </p>
          </div>
          
           <div class="notification">
                <a href="#">New Blog Post</a>
            <p>
              <strong>Abraham</strong> has posted a new blog post: <br>
                Nulla facilisi. Etiam dignissim metus nibh, nec malesuada tortor pretium quis. Ut id rutrum neque, eget aliquet neque. Sed magna lectus, molestie et nibh quis, consectetur efficitur velit. Morbi sit amet ipsum non justo laoreet venenatis in ut justo. Ut porttitor lectus odio, nec cursus lacus aliquet non. Fusce ac enim a orci facilisis rutrum....
            </p>
          </div>
          
           <div class="notification">
                <a href="#">New Blog Post</a>
            <p>
              <strong>Jinyu</strong> has posted a new blog post: <br>
                Curabitur lobortis tortor ac lectus interdum, sed gravida ipsum efficitur. Proin in egestas urna. Maecenas nec lobortis erat. Sed vitae cursus augue. Morbi egestas iaculis mi, at tincidunt tellus elementum ac. Suspendisse in interdum diam. Proin congue enim condimentum eros suscipit gravida. Integer laoreet elit sed placerat luctus. Pellentesque...
            </p>
          </div>
          
           <div class="notification">
                <a href="#">New Blog Post</a>
            <p>
              <strong>Keith</strong> has posted a new blog post: <br>
                Vestibulum gravida tortor sed odio faucibus bibendum non eu turpis. Donec vel elit tempus, convallis sapien a, eleifend ante. Vestibulum viverra congue condimentum. Fusce pulvinar justo varius, scelerisque mauris ut, elementum turpis. Quisque a turpis eu nisi pulvinar mattis non sit amet nisl. Vestibulum hendrerit...
            </p>
          </div> -->
      </div>


    <script>
    var firebaseConfig = {
      apiKey: "AIzaSyAT3nO748LYDdkwXQFwHNlei_AnlQEXG98",
      authDomain: "educationalmanagement-44760.firebaseapp.com",
      databaseURL: "https://educationalmanagement-44760.firebaseio.com",
      projectId: "educationalmanagement-44760",
      storageBucket: "educationalmanagement-44760.appspot.com",
      messagingSenderId: "357116925214",
      appId: "1:357116925214:web:77a9f6e3199168b149650f",
      measurementId: "G-0ZSQM3PN5L"
    }

    firebase.initializeApp(firebaseConfig);
    var firestore = firebase.firestore();

    //var user = firebase.auth().currentUser;
    firebase.auth().onAuthStateChanged(user => {
        if(user) {
          document.getElementById('logging').innerHTML = "Log out";
        }
        else{
          document.getElementById('logging').innerHTML = "Log in";
        }
      });
    
    var signedIn = localStorage.getItem('ermSignInState');
    if (signedIn == '1'){
      document.getElementById('logging').innerHTML = "Log out";
    }
    else{
      document.getElementById('logging').innerHTML = "Log in";
    }

    function handleLogging(){
      console.log("handle logging");
      var currentState = document.getElementById('logging').innerHTML;
      if (currentState == "Log in"){
        window.location = ("login.html");
      }
      else if (currentState == "Log out"){
        document.getElementById('logging').innerHTML = "Log in";
        firebase.auth().signOut().then(function() {
          localStorage.setItem('ermSignInState', '0');
          localStorage.setItem('adminStatus', '0');
          console.log("Logged out");  
        }).catch(function(error) {
          console.log("Unable to log out");
        });
      }
      else{
        console.log("Error");
      }
    }
    
    </script>

    <script>
    function subscribe() {

        if(signedIn!='1'){
            window.location=('login.html');
        }

        var isCourse1Valid = false;
        var isCourse2Valid = false;
        var isCourse3Valid = false;

        var course1 = document.getElementById("course1").value;
        var course2 = document.getElementById("course2").value;
        var course3 = document.getElementById("course3").value;

        if (course1 == '') {
          document.getElementById("error-cname1").classList.remove('error-dis');
          isCourse1Valid = false;
        } else {
          document.getElementById("error-cname1").classList.add('error-dis');
          isCourse1Valid = true;
        }

        if (course2 == '') {
          document.getElementById("error-cname2").classList.remove('error-dis');
          isCourse2Valid = false;
        } else {
          document.getElementById("error-cname2").classList.add('error-dis');
          isCourse2Valid = true;
        }

        if (course3 == '') {
          document.getElementById("error-cname3").classList.remove('error-dis');
          isCourse3Valid = false;
        } else {
          document.getElementById("error-cname3").classList.add('error-dis');
          isCourse3Valid = true;
        }

        if(isCourse1Valid && isCourse2Valid && isCourse3Valid) {
          course1 = course1.toUpperCase();
          course2 = course2.toUpperCase();
          course3 = course3.toUpperCase();
          handleThis(course1, course2, course3);
        }else {
          return;
        }
      }
    
    function handleThis(c1, c2, c3){
    firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
    // User is signed in.
    var uid = user.uid;
    var course1 = c1;
    var course2 = c2;
    var course3 = c3;
  
    if(course1 != null && course2!=null && course3!=null){
      firestore.collection("Users").where('account_id','==',uid)
      .get()
      .then(function(querySnapshot){
        querySnapshot.forEach(function(doc){
          firestore.collection("Users").doc(doc.id).collection("Subjects").doc().set({
            Course1 : course1,
            Course2 : course2,
            course3 : course3
          }).then(function () {
              console.log("Document successfully written!");
              })
            .catch(function (error) {
              console.error("Error writing document: ", error);
              });
        })
      })
    }

    firestore.collection("Posts").where('course','==',course1)
      .get()
      .then(function(querySnapshot) {
      querySnapshot.forEach(function(doc) {
      
    firestore.collection("Posts").doc(doc.id)
      .get().then(function(doc){
        if (doc.exists) {
          firestore.collection("Messages").doc().set({
            From : doc.get("displayName"),
            Subject : doc.get("header"),
            Message : doc.get("body"),
            To : user.uid
          }).then(function () {
              console.log("Document successfully written!");
              })
            .catch(function (error) {
              console.error("Error writing document: ", error);
              });
      } else {
        console.log("No such document!");
      }
    }).catch(function(error) {
    console.log("Error getting document:", error);
    });

          
    });
  }).catch(function(error) {
        console.log("Error getting documents: ", error);
    });

    firestore.collection("Posts").where('course','==',course2)
      .get()
      .then(function(querySnapshot) {
      querySnapshot.forEach(function(doc) {
      
    firestore.collection("Posts").doc(doc.id)
      .get().then(function(doc){
        if (doc.exists) {
          firestore.collection("Messages").doc().set({
            From : doc.get("displayName"),
            Subject : doc.get("body"),
            To : user.uid
          }).then(function () {
              console.log("Document successfully written!");
              })
            .catch(function (error) {
              console.error("Error writing document: ", error);
              });
      } else {
        console.log("No such document!");
      }
    }).catch(function(error) {
    console.log("Error getting document:", error);
    });

          
    });
  }).catch(function(error) {
        console.log("Error getting documents: ", error);
    });

    firestore.collection("Posts").where('course','==',course3)
      .get()
      .then(function(querySnapshot) {
      querySnapshot.forEach(function(doc) {
      
    firestore.collection("Posts").doc(doc.id)
      .get().then(function(doc){
        if (doc.exists) {
          firestore.collection("Messages").doc().set({
            From : doc.get("displayName"),
            Subject : doc.get("body"),
            To : user.uid
          }).then(function () {
              console.log("Document successfully written!");              
              })
            .catch(function (error) {
              console.error("Error writing document: ", error);
              });
      } else {
        console.log("No such document!");
      }
    }).catch(function(error) {
    console.log("Error getting document:", error);
    });

          
    });
  }).catch(function(error) {
        console.log("Error getting documents: ", error);
    });
   

}
else {
    // User is signed out.
    // ...
    }
  });
  

setTimeout(() => {window.location="./messages.html"; count++;}, 10000);
    
}

</script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  </body>
</html>
